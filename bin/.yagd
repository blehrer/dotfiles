#!/bin/bash

function cfg_repo() {
    local dir=`basename $(git rev-parse --show-toplevel)`
    [ -f .yagconf ] && local dir=$(cat .yagconf | tail -1)
    local suffix=config-repo
    [[ $dir == digsrv* ]] && echo $NBCUOTS/digsrv-$suffix
    [[ $dir == cp* ]] && echo $NBCUOTS/cp-$suffix
    return
}

function yagdWithErrorHandling() {
    [[ -z $(which yag) ]] && {
        echo "yag is not on PATH"
        return 1
    } || {
        declare -A exceptions
        exceptions[digsrv-cds-ingest-mpx]="cds-ingest-mpx"
        exceptions[digsrv-cds-ingest-mpx-sqe]="cds-ingest-qa"
        exceptions[cp-manatees-performance-tests]="cp-transfer-performance-tests"
        local suffix

        while getopts 'hs:q:' 'OPTKEY'; do
        case ${OPTKEY} in
            'h')
            yag -h
            ;;
            's')
            local suffix=$OPTARG
            ;;
            'q')
            local query=$OPTARG
            ;;
        esac
        done

        [ $suffix ] && suffix="-$suffix"

        local repo=$(basename $(git rev-parse --show-toplevel))$suffix
        [ -f .yagconf ] && local repo=$(cat .yagconf | tail -1)$suffix

        echo repo: $repo
        echo exception: ${exceptions[$repo]}
        [[ -n ${exceptions[$repo]} ]] && {
            yag -d `cfg_repo`/${exceptions[$repo]} $query
        } || {
            yag -d `cfg_repo`/$repo $query
        }
    }
    return
}


yagdWithErrorHandling "$@"
